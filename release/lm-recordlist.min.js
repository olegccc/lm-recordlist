!function(){function a(angular){var a=angular.module("lm-recordlist",["ngMaterial","ngTouch","ngMessages","ngAnimate","pascalprecht.translate"]),b={"views/optionsBar.jade":'<tr ng-show="showOptions" class="options-panel"><td colspan="{{columns.length+1}}"><md-button ng-disabled="!isActionVisible(action)" ng-repeat="action in actions" ng-bind="action.text | translate" ng-click="executeAction(action)" aria-label="action.text | translate" class="md-primary md-raised"></md-button><span ng-repeat="link in links"><node-link ng-if="!link.external" path="{{linkUrl(link)}}" ng-bind="link.text | translate" class="btn btn-info"></node-link><a ng-if="link.external" href="{{linkUrl(link)}}" ng-bind="link.text | translate" class="btn btn-info"></a></span></td></tr>',"views/paging.jade":"","views/recordList.jade":'<div layout="row"><div ng-if="toolbarButtons.length &gt; 0" class="grid-control-panel-top"><md-button ng-repeat="button in toolbarButtons" aria-label="button.text | translate" ng-click="onToolbarButtonClick(button)" ng-bind="button.text | translate" class="md-default md-raised"></md-button></div><div ng-if="manualRefresh" class="recordlist-refresh-panel"><md-button ng-click="refreshNewRecords()" ng-show="hasNewRecords" class="md-primary">{{ \'Main.GetNewRecords\' | translate }}</md-button></div><pagination ng-show="showPagination" items-per-page="itemsPerPage" boundary-links="true" direction-links="true" total-items="totalItems" ng-model="currentPageNumeric" previous-text="&amp;lsaquo;" next-text="&amp;rsaquo;" first-text="&amp;laquo;" last-text="&amp;raquo;" max-size="paginationItems" ng-class="{ \'grid-refreshing\' : updating }" class="pagination-sm pagination-top"></pagination><table ng-class="{ \'show-options\' : showOptions, \'has-options\' : hasOptionsBar, \'grid-refreshing\' : updating }" class="grid-control"><tr><th ng-repeat="column in columns" width="{{column.width}}" colspan="{{column.colSpan}}" class="{{column.headerClass}}"><span ng-click="sortColumn(column)" ng-bind="column.text | translate" ng-class="{ \'sort-up\' : column.sort == \'up\', \'sort-down\' : column.sort == \'down\' }"></span><span ng-if="hasRecordSearch &amp;&amp; column == columns[columns.length-1]" class="toggle-search-button"><ng-button ng-click="toggleRecordSearch()"><span ng-class="{ \'glyphicon-chevron-up\' : recordSearchVisible, \'glyphicon-search\' : !recordSearchVisible }" class="glyphicon"></span></ng-button></span></th></tr><tr ng-if="hasRecordSearch" ng-show="recordSearchVisible" class="search-row"><td colspan="{{(tableColumns)}}"><form ui-keypress="{ 13: searchRecords() }"><table><tr><td><input type="text" placeholder="Enter text to search" ng-model="getRecordListScope().recordSearchText" class="form-control"/></td><td><ng-button ng-click="searchRecords()"><span class="glyphicon glyphicon-search"></span></ng-button></td></tr></table></form></td></tr><tr ng-repeat="row in rows" ng-class="{ \'odd\': row.isOdd }"><td ng-if="hasOptionsBar" ng-class="columns[0].cellClass" cell-show-options="" ng-click="onClickOptions(row, null, $event)" class="grid-cell-options"><span></span></td><td ng-repeat="column in columns" bind-cell="column" row="row" ng-class="column.cellClass" cell-show-options="" ng-click="onClickOptions(row, column, $event)"></td></tr></table><pagination ng-show="showPagination" items-per-page="itemsPerPage" boundary-links="true" direction-links="true" total-items="totalItems" ng-model="currentPageNumeric" previous-text="&amp;lsaquo;" next-text="&amp;rsaquo;" first-text="&amp;laquo;" last-text="&amp;raquo;" max-size="paginationItems" ng-class="{ \'grid-refreshing\' : updating }" class="pagination-sm"></pagination><div ng-if="toolbarButtons.length &gt; 0" class="grid-control-panel-bottom"><md-button ng-repeat="button in toolbarButtons" aria-label="button.text | translate" ng-click="onToolbarButtonClick(button)" ng-bind="button.text | translate" class="md-default md-raised"></md-button></div></div>',"views/toolBar.jade":""},c=function(){function a(){}return a}(),d=(function(){function a(){}return a}(),function(){function a(){}return a.RECORD="RECORD",a.RECORD_CREATE="RECORD_CREATE",a.RECORD_INITIALIZE_CREATE="RECORD_INITIALIZE_CREATE",a.CREATE="CREATE",a}()),e=(function(){function a(){}return a}(),function(){function a(){}return a}(),function(){function a(){}return a}(),function(){function a(){}return a}()),f=function(){function a(a,b,c){this.scope=a,this.records=[],this.pageConfiguration=b,this.moduleConfiguration=c,this.manualRefresh=!1,this.subscribeToChannel()}return a.prototype.subscribeToChannel=function(){var a=this,b=this.scope.channel.subscribe(this);this.scope.$on("$destroy",function(){a.scope.channel.unsubscribe(b)})},a.prototype.onRecordIdsReceived=function(a){var b=this;this.scope.hasNewRecords=!1;var c={};this.records.forEach(function(a){a.loaded&&(c[a.id]=a)}),this.records=[],a.forEach(function(a){var d;d=c.hasOwnProperty(a.toString())?c[a]:b.createNewRecord(a),b.records.push(d)}),this.loadVisibleRecords()},a.prototype.refreshNewRecords=function(){var a=this;this.scope.channel.readIds().then(function(b){a.onRecordIdsReceived(b)})},a.prototype.recordCreated=function(a,b){this.manualRefresh&&(this.scope.hasNewRecords=!0),this.refreshNewRecords()},a.prototype.recordRemoved=function(a){for(var b=!1,c=0;c<this.records.length;c++){var d=this.records[c];if(d.id===a){this.records.splice(c,1),b=this.pageConfiguration.isRecordBeforePageEnd(c);break}}b&&this.loadVisibleRecords()},a.prototype.recordUpdated=function(a){for(var b=0;b<this.records.length;b++){var c=this.records[b];if(c.id===a){this.pageConfiguration.isRecordVisible(b)?this.updateVisibleRecords([a],this.scope.currentPage):this.records[b]=this.createNewRecord(a);break}}},a.prototype.onModelLoaded=function(a){this.manualRefresh=a.manualRefresh},a.prototype.getRecordById=function(a){for(var b=0;b<this.records.length;b++){var c=this.records[b];if(c.id===a)return c}return null},a.prototype.resetRecords=function(a){this.records=[];for(var b=0;b<a.length;b++){var c=a[b],d=this.createNewRecord(c);this.records.push(d)}},a.prototype.createNewRecord=function(a){var b=new e;return b.loaded=!1,this.scope.columns.forEach(function(a){b[a.name]=""}),b.id=a,b},a.prototype.sort=function(a,b){for(var c=this,d=0,e=0;e<this.records.length;e++){var f=this.records[e];f.loaded||d++}return 0!==d?void this.scope.channel.readIdsSortedBy(a,b).then(function(a){c.resetRecords(a)},function(a){c.moduleConfiguration.errorHandler&&c.moduleConfiguration.errorHandler(a)}):void this.records.sort(function(b,c){var d=b[a],e=c[a];return d===e?0:e>d?-1:1})},a.prototype.updateRecords=function(b){for(var c=0;c<b.length;c++)for(var d=b[c],e=d.id,f=a.createRecordCopy(d),g=0;g<this.records.length;g++){var h=this.records[g],i=h.id;if(i===e){this.records[g]=f;for(var j=0;j<this.scope.rows.length;j++){var k=this.scope.rows[j];if(k.id===e){this.scope.rows[j]=f,f.isOdd=j%2!==0;break}}break}}},a.prototype.loadVisibleRecords=function(){this.showPage(this.scope.currentPage)},a.createRecordCopy=function(a){return a.loaded=!0,a},a.prototype.showPage=function(a){if(!this.scope.updating){var b=[];this.pageConfiguration.setCurrentPage(a);var c=this.pageConfiguration.getVisibleRecords(this.records);if(c.forEach(function(a){a.loaded||b.push(a)}),b.length>0)return this.scope.updating=!0,void this.updateVisibleRecords(b,a);this.scope.currentPage=a,this.scope.showOptions=!1,c.forEach(function(a){b.push(a),a.isOdd=b.length%2!==0}),this.scope.showPagination=this.pageConfiguration.hasPagination(),this.scope.rows=b,this.scope.pageLoaded=!0}},a.prototype.updateVisibleRecords=function(a,b){var c=this;this.scope.channel.readRecords(a).then(function(a){c.scope.updating=!1,c.updateRecords(a),c.showPage(b)},function(a){c.moduleConfiguration.errorHandler&&c.moduleConfiguration.errorHandler(a),c.scope.updating=!1})},a}(),g=function(){function a(a){this.defaultPageSize=a.pageSize,this.defaultPageSize<=0&&(this.defaultPageSize=10),this.setRecordCount(0),this.setCurrentPage(1)}return a.prototype.isRecordBeforePageEnd=function(a){return this.pageSize>0?a<this.pageOffset+this.pageSize:!1},a.prototype.hasPagination=function(){return this.pageSize<this.totalItems},a.prototype.isRecordVisible=function(a){return this.pageSize>0&&a>=this.pageOffset&&a<this.pageOffset+this.pageSize},a.prototype.getVisibleRecords=function(a){for(var b=[],c=this.pageOffset,d=c+this.pageSize,e=c;d>e;e++)b.push(a[e]);return b},a.prototype.setCurrentPage=function(a){var b=a;"last"===b&&(b=this.pageCount),1>b?b=1:b>this.pageCount&&(b=this.pageCount>0?this.pageCount:1);var c=(b-1)*this.defaultPageSize,d=this.defaultPageSize;0===this.pageCount?this.pageSize=0:c+d>this.totalItems&&(this.pageSize=this.totalItems-c)},a.prototype.setRecordCount=function(a){this.itemsPerPage=this.pageSize,this.totalItems=a;var b=this.defaultPageSize;this.pageCount=(this.totalItems+b-1)/b|0},a}(),h=function(){function a(a){this.scope=a,this.initializeScope()}return a.prototype.initializeScope=function(){this.scope.tableColumns=0,this.scope.actions=[],this.scope.showOptions=!1,this.scope.currentPage=0,this.scope.showPagination=!1,this.scope.paginationItems=7,this.scope.rows=[],this.scope.pageLoaded=!1,this.scope.toolbarButtons=[],this.scope.hasNewRecords=!1,this.scope.updating=!1,this.scope.recordSearchVisible=!1,this.scope.recordSearchText="",this.scope.links=[],this.scope.columns=[],this.scope.hasRecordSearch=!1},a.prototype.onDataDefinitionLoaded=function(a){this.scope.links=a.links,this.scope.columns=a.columns,this.scope.hasRecordSearch=a.hasSearch,this.scope.hasOptionsBar=this.scope.columns.length>0&&(this.scope.actions.length>0||this.scope.links.length>0),this.initializeActions(a),this.initializeColumnScopes(),this.initializeColumns()},a.prototype.initializeColumnScopes=function(){this.scope.columns.forEach(function(a){a.colSpan=1,a.scope&&a.scope.length?a.context=new Function("obj","with(obj) { return "+a.scope+"; }"):a.context=function(a){return a}})},a.prototype.initializeActions=function(a){var b=this;a.actions.forEach(function(a){var e;switch(e=a.visible&&a.visible.length>0?new Function("obj","with(obj) { return "+a.visible+"; }"):function(){return!0},a.type){case d.RECORD:case d.RECORD_CREATE:case d.RECORD_INITIALIZE_CREATE:var f=new c;f.name=a.name,f.text=a.text,f.visible=e,f.type=a.type,f.parameter=a.parameter,b.scope.actions.push(f);break;case d.CREATE:var f=new c;f.name=a.name,f.text=a.text,f.visible=e,f.type=a.parameter,b.scope.toolbarButtons.push(f)}})},a.prototype.initializeColumns=function(){for(var a=0;a<this.scope.columns.length;a++){var b=this.scope.columns[a];switch(this.scope.tableColumns+=b.colSpan,b.headerClass||(b.headerClass=""),b.cellClass?b.cellClass+=" grid-data":b.cellClass="grid-data",b.align){case"Left":b.cellClass+=" grid-left",b.headerClass+=" grid-left";break;case"Center":b.cellClass+=" grid-center",b.headerClass+=" grid-center";break;case"Right":b.cellClass+=" grid-right",b.headerClass+=" grid-right"}if(b.ignoreOptions&&(b.cellClass+=" ignore-options"),!b.template||0===b.template.length){var c="data."+b.name,d="ng-bind";b.allowUnsafe&&(c="getSafeValue("+c+")",d="ng-bind-html"),b.url&&b.url.length>0?b.template='<a href="{{getColumnLink(column, row)}}" ng-click="navigateToView(getColumnLink(column, row))" '+d+'="'+c+'"></a>':b.template="<span "+d+'="'+c+'"></span>'}}},a}(),i=function(){function a(a,b,c,d){this.scope=a,this.httpService=c,this.configuration=b,this.qService=d,this.modelId=a.model,this.dataDefinition=null,this.pageConfiguration=new g(b),this.dataChannelController=new f(a,this.pageConfiguration,this.configuration);var e=new h(a);this.setScopeEvents(),this.currentRecordId=null,this.currentRecord=null,this.dataChannelController.subscribeToChannel(),this.scope.hasOptionsBar&&(this.scope.columns[0].colSpan=2),this.loadModel(e)}return a.prototype.setScopeEvents=function(){var b=this;this.scope.onSearchRecords=function(){return b.onSearchRecords()},this.scope.onToggleRecordSearch=function(){return b.toggleRecordSearch()},this.scope.onRefreshNewRecords=function(){return b.dataChannelController.refreshNewRecords()},this.scope.onToolbarButtonClick=function(a){return b.onToolbarButtonClick(a)},this.scope.onClickOptions=function(a,c,d){return b.onClickOptions(a,c,d)},this.scope.isActionVisible=function(a){return b.isActionVisible(a)},this.scope.onSortColumn=function(a){return b.sortColumn(a)},this.scope.getColumnLink=function(b,c){return a.extractLink(b.url,c)},this.scope.onExecuteAction=function(a){return b.executeAction(a)},this.scope.onNavigateToLink=function(a){return b.configuration.navigate(a)}},a.prototype.isActionVisible=function(a){return null!==this.currentRecord&&this.scope.showOptions?a.visibleFunction(this.currentRecord):!1},a.prototype.loadModel=function(a){var b=this;this.httpService.get(this.modelId+".json",{cache:!0}).then(function(c){b.onModelLoaded(c.data,a)},function(a){b.configuration.errorHandler&&b.configuration.errorHandler(a)})},a.prototype.onModelLoaded=function(a,b){var c=this;this.dataDefinition=a,this.dataDefinition.extensionScript&&this.dataDefinition.extensionScript.length?require([this.dataDefinition.extensionScript],function(d){d(c.scope),c.onModelAndExtensionsLoaded(a,b)}):this.onModelAndExtensionsLoaded(a,b)},a.prototype.onModelAndExtensionsLoaded=function(a,b){b.onDataDefinitionLoaded(a),this.dataChannelController.onModelLoaded(a),this.dataChannelController.refreshNewRecords()},a.prototype.onToolbarButtonClick=function(a){var b=this;this.scope.updating||this.scope.actionHandler(a.name,null).then(function(c){b.configuration.editRecord(c,function(c){var d=b.qService.defer();return b.scope.actionHandler(a.name,c).then(function(){d.resolve()},function(a){return d.reject(a)}),d.promise})})},a.prototype.onSearchRecords=function(){this.scope.recordSearchText.length>0?this.filter={search:this.scope.recordSearchText}:this.filter=null,this.dataChannelController.refreshNewRecords()},a.prototype.toggleRecordSearch=function(){this.scope.recordSearchVisible=!this.scope.recordSearchVisible,this.scope.recordSearchVisible||this.scope.recordSearchText.length>0&&(this.scope.recordSearchText="",this.onSearchRecords())},a.prototype.hideOptions=function(){this.scope.showOptions=!1},a.prototype.onClickOptions=function(a,b,c){if(!this.scope.updating&&this.scope.hasOptionsBar&&!(c&&c.target&&"A"===c.target.nodeName||null!==b&&b.ignoreOptions)){var d=a.id;this.currentRecord&&this.currentRecordId===d?this.scope.showOptions=!this.scope.showOptions:this.scope.showOptions=!0,this.currentRecordId=d,this.currentRecord=a}},a.prototype.sortColumn=function(a){if(a.sortable&&!this.scope.updating){for(var b=a.sort,c=0;c<this.scope.columns.length;c++){var a=this.scope.columns[c];a.sort=""}b=b&&"up"!==b?"up":"down",a.sort=b,this.hideOptions();var d=a.name;this.dataChannelController.sort(d,b),this.dataChannelController.showPage(1)}},a.prototype.editCurrentRecord=function(a){var b=this;this.configuration.editRecord(a,function(a){var c=b.qService.defer();return b.scope.channel.writeRecords([a]).then(function(){c.resolve()},function(a){c.reject(a)}),c.promise})},a.prototype.executeAction=function(a){var b=this;if(null!==this.currentRecordId){if("modifyRecord"===a.name){var c=this.dataChannelController.getRecordById(this.currentRecordId);if(!c)return;return void this.editCurrentRecord(c)}var e={};e.id=this.currentRecordId;var f=function(){var c=b.qService.defer();return b.scope.actionHandler(a.name,e).then(function(){c.resolve()}),c.promise};a.type===d.RECORD_INITIALIZE_CREATE?this.scope.actionHandler(a.name,e).then(function(a){b.configuration.editRecord(a,function(a){return e=a,f()})},function(a){b.configuration.errorHandler&&b.configuration.errorHandler(a)}):a.type===d.RECORD_CREATE?this.configuration.editRecord(null,function(){return f()}):f()["catch"](function(a){b.configuration.errorHandler&&b.configuration.errorHandler(a)})}},a.extractLink=function(a,b){for(var c=a,d=0;;){var e=c.indexOf("{",d);if(0>e)break;var f=c.indexOf("}",e);if(0>f)break;var g=c.substring(e+1,f);b.hasOwnProperty(g)?(g=b[g],c=c.substring(0,e)+g+c.substring(f+1),d+=g.length):d=e+1}return c},a}();a.directive("recordList",["moduleConfiguration","$http","$q",function(a,c,d){return{restrict:"EA",template:b["views/recordList.jade"],scope:{model:"=",channel:"=",actionHandler:"=",pageHandler:"="},link:function(b){return new i(b,a,c,d)}}}]);(function(){function a(){}return a})()}if("function"==typeof define&&define.amd)define(["angular","angular.animate","angular.translate","angular.messages","angular.material","angular.aria","angular.touch"],function(angular,b,c,d,e,f,g){a(angular)});else if("object"==typeof exports){var angular=require("angular");require("angular.animate"),require("angular.translate"),require("angular.messages"),require("angular.material"),require("angular.aria"),require("angular.touch"),module.exports=a(angular)}else a(angular)}();