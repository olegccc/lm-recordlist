!function(){function a(angular){var a=angular.module("lm-recordlist",["ngMaterial","ngTouch","ngMessages","ngAnimate","pascalprecht.translate"]);a.config(["$translateProvider",function(a){a.useSanitizeValueStrategy("escape")}]);var b={"views/optionsBar.jade":'<tr ng-show="showOptions" class="options-panel"><td colspan="{{columns.length+1}}"><md-button ng-disabled="!isActionVisible(action)" ng-repeat="action in actions" ng-bind="action.text | translate" ng-click="executeAction(action)" aria-label="action.text | translate" class="md-primary md-raised"></md-button><span ng-repeat="link in links"><node-link ng-if="!link.external" path="{{linkUrl(link)}}" ng-bind="link.text | translate" class="btn btn-info"></node-link><a ng-if="link.external" href="{{linkUrl(link)}}" ng-bind="link.text | translate" class="btn btn-info"></a></span></td></tr>',"views/paging.jade":'<div layout="row" ng-if="showPagination" class="pagination"><md-button ng-if="showFastBackward" ng-click="onFastBackward()" class="md-raised md-mini">&laquo;;</md-button><md-button ng-if="showBackward" ng-click="onBackward()" class="md-raised">&lsaquo;</md-button><md-button ng-repeat="page in pages" ng-click="onPage(page)" ng-bind="page.title" ng-disabled="page.pageNumber === currentPage" class="md-raised"></md-button><md-button ng-if="showForward" ng-click="onForward()" class="md-raised">&rsaquo;</md-button><md-button ng-if="showFastForward" ng-click="onFastForward()" class="md-raised">&raquo;</md-button></div>',"views/recordList.jade":'<div layout="column" class="record-list"><record-list-toolbar></record-list-toolbar><record-list-refresh-panel></record-list-refresh-panel><record-list-pagination page-size="getPageSize()" record-count="getRecordCount()" current-page="currentPage"></record-list-pagination><div ng-class="{ \'has-options\' : hasOptionsBar, \'grid-refreshing\' : updating, \'sortable\': columnsSortable }" layout="column" class="grid-control"><md-toolbar layout="row" class="grid-row md-theme-light"><div ng-repeat="column in columns" md-colspan="column.colSpan" ng-class="column.headerClass" flex="column.width" class="grid-header-cell"><span ng-click="sortColumn(column)" tabindex="-1" role="option" ng-bind="column.title | translate" ng-class="{ \'sort-up\' : column.sort == \'up\', \'sort-down\' : column.sort == \'down\' }"></span><span ng-if="hasRecordSearch &amp;&amp; $last" class="toggle-search-button"><ng-button ng-click="toggleRecordSearch()"><span ng-class="{ \'glyphicon-chevron-up\' : recordSearchVisible, \'glyphicon-search\' : !recordSearchVisible }" class="glyphicon"></span></ng-button></span></div></md-toolbar><div layout="row" class="grid-row"><div ng-if="hasRecordSearch" ng-show="recordSearchVisible" flex="flex" class="grid-header-cell"><input type="text" placeholder="Enter text to search" ng-model="getRecordListScope().recordSearchText" class="form-control"/></div><div ng-if="hasRecordSearch" ng-show="recordSearchVisible" class="grid-header-cell"><ng-button ng-click="searchRecords()"><span class="glyphicon glyphicon-search"></span></ng-button></div></div><div ng-repeat-start="row in rows" ng-class="{ \'odd\': $odd }" layout="row" ng-click="onClickOptions(row, $event)" role="option" tabindex="-1" class="grid-row"><div ng-repeat="column in columns" ng-class="column.cellClass" layout="row" flex="column.width" class="grid-cell"><div ng-if="hasOptionsBar &amp;&amp; $first" class="grid-cell-options"><md-icon>more_vert</md-icon></div><span bind-cell="column" row="row" flex="flex"></span></div></div><div layout="row" ng-if="hasOptionsBar &amp;&amp; row.showOptions"><md-button ng-repeat="action in actions" ng-click="onExecuteAction(action, row)" ng-show="isActionVisible(action, row)" aria-label="action.title" class="md-raised"><span ng-bind="action.title"></span></md-button></div><md-divider ng-repeat-end="ng-repeat-end"></md-divider></div><record-list-pagination page-size="getPageSize()" record-count="getRecordCount()" current-page="currentPage"></record-list-pagination><record-list-toolbar></record-list-toolbar></div>',"views/refreshPanel.jade":'<div ng-if="manualRefresh" class="recordlist-refresh-panel"><md-button ng-click="refreshNewRecords()" ng-show="hasNewRecords" class="md-primary">{{ \'Main.GetNewRecords\' | translate }}</md-button></div>',"views/toolBar.jade":'<div class="grid-toolbar"><md-button ng-repeat="button in toolbarButtons" aria-label="button.text | translate" ng-click="onToolbarButtonClick(button)" ng-bind="button.title | translate" class="md-default md-raised"></md-button></div>'},c=function(){function a(){}return a}(),d=(function(){function a(){}return a}(),function(){function a(){}return a.RECORD="RECORD",a.RECORD_CREATE="RECORD_CREATE",a.RECORD_INITIALIZE_CREATE="RECORD_INITIALIZE_CREATE",a.CREATE="CREATE",a}()),e=(function(){function a(){}return a}(),function(){function a(){}return a.MODIFY_RECORD_ACTION="modifyRecord",a.SORT_DIRECTION_UP="up",a.SORT_DIRECTION_DOWN="down",a}()),f=(function(){function a(){}return a}(),function(){function a(){}return a}()),g=function(){function a(){this.editRecord=null,this.navigate=null,this.pageSize=10,this.errorHandler=null}return a}();a.service("recordListConfiguration",[g]);var h=function(){function a(a,b,c){this.scope=a,this.records=[],this.loadedRecords={},this.pageConfiguration=b,this.moduleConfiguration=c,this.manualRefresh=!1,this.subscribeToChannel()}return a.prototype.writeRecords=function(a){return this.channel.writeRecords(a)},a.prototype.subscribeToChannel=function(){var a=this;this.channel=this.scope.channel.subscribe(this),this.scope.$on("$destroy",function(){a.scope.channel.unsubscribe(a.channel)})},a.prototype.getRecordCount=function(){return this.records?this.records.length:0},a.prototype.onRecordIdsReceived=function(a){var b=this;this.scope.hasNewRecords=!1;var c={};this.records.forEach(function(a){b.loadedRecords[a.id]&&(c[a.id]=a)}),this.records=[],this.loadedRecords={},a.forEach(function(a){var d;c.hasOwnProperty(a.toString())?(d=c[a],b.loadedRecords[a]=!0):d=b.createNewRecord(a),b.records.push(d)}),this.pageConfiguration.setRecordCount(this.records.length),this.loadVisibleRecords()},a.prototype.refreshNewRecords=function(){var a=this;this.channel.readIds().then(function(b){a.onRecordIdsReceived(b)})},a.prototype.recordCreated=function(a,b){this.manualRefresh&&(this.scope.hasNewRecords=!0),this.pageConfiguration.setRecordCount(this.records.length),this.refreshNewRecords()},a.prototype.recordRemoved=function(a){for(var b=!1,c=0;c<this.records.length;c++){var d=this.records[c];if(d.id===a){this.records.splice(c,1),b=this.pageConfiguration.isRecordBeforePageEnd(c);break}}this.pageConfiguration.setRecordCount(this.records.length),b&&this.loadVisibleRecords()},a.prototype.recordUpdated=function(a){for(var b=0;b<this.records.length;b++){var c=this.records[b];if(c.id===a){this.pageConfiguration.isRecordVisible(b)?this.updateVisibleRecords([a],this.scope.currentPage):(this.records[b]=this.createNewRecord(a),this.loadedRecords[a]=!1);break}}},a.prototype.onModelLoaded=function(a){this.manualRefresh=a.manualRefresh},a.prototype.getRecordById=function(a){for(var b=0;b<this.records.length;b++){var c=this.records[b];if(c.id===a)return c}return null},a.prototype.resetRecords=function(a){this.records=[],this.loadedRecords={};for(var b=0;b<a.length;b++){var c=a[b],d=this.createNewRecord(c);this.records.push(d)}this.pageConfiguration.setRecordCount(this.records.length)},a.prototype.createNewRecord=function(a){var b=new f;return this.scope.columns.forEach(function(a){b[a.property]=""}),b.id=a,b},a.prototype.sort=function(a,b){for(var c=this,d=0,e=0;e<this.records.length;e++){var f=this.records[e];this.loadedRecords[f.id]||d++}return 0!==d?void this.channel.sortByAndReadIds(a,"down"===b).then(function(a){c.resetRecords(a)},function(a){c.moduleConfiguration.errorHandler&&c.moduleConfiguration.errorHandler(a)}):void this.records.sort(function(b,c){var d=b[a],e=c[a];return d===e?0:e>d?-1:1})},a.prototype.updateRecords=function(b){for(var c=0;c<b.length;c++)for(var d=b[c],e=d.id,f=a.createRecordCopy(d),g=0;g<this.records.length;g++){var h=this.records[g];if(h.id===e){this.records[g]=f,this.loadedRecords[f.id]=!0;break}}},a.prototype.loadVisibleRecords=function(){this.showPage(this.scope.currentPage)},a.createRecordCopy=function(a){return a},a.prototype.showPage=function(a){var b=this;if(!this.scope.updating){var c=[],d=[];this.pageConfiguration.setCurrentPage(a);var e=this.pageConfiguration.getVisibleRecords(this.records);if(e.forEach(function(a){b.loadedRecords[a.id]||d.push(a.id)}),d.length>0)return this.scope.updating=!0,void this.updateVisibleRecords(d,a);this.scope.currentPage=a,e.forEach(function(a){var b={id:a.id,showOptions:!1,record:a};c.push(b)}),this.scope.showPagination=this.pageConfiguration.hasPagination(),this.scope.rows=c,this.scope.pageLoaded=!0}},a.prototype.updateVisibleRecords=function(a,b){var c=this;this.channel.readRecords(a).then(function(a){c.scope.updating=!1,c.updateRecords(a),c.showPage(b)},function(a){c.moduleConfiguration.errorHandler&&c.moduleConfiguration.errorHandler(a),c.scope.updating=!1})},a}(),i=function(){function a(a){this.defaultPageSize=a.pageSize,this.defaultPageSize<=0&&(this.defaultPageSize=10),this.setRecordCount(0),this.setCurrentPage(1)}return a.prototype.isRecordBeforePageEnd=function(a){return this.pageSize>0?a<this.pageOffset+this.pageSize:!1},a.prototype.hasPagination=function(){return this.pageSize<this.totalItems},a.prototype.isRecordVisible=function(a){return this.pageSize>0&&a>=this.pageOffset&&a<this.pageOffset+this.pageSize},a.prototype.getVisibleRecords=function(a){for(var b=[],c=this.pageOffset,d=c+this.pageSize,e=c;d>e;e++)b.push(a[e]);return b},a.prototype.setCurrentPage=function(a){var b=a;"last"===b&&(b=this.pageCount),1>b?b=1:b>this.pageCount&&(b=this.pageCount>0?this.pageCount:1),this.pageOffset=(b-1)*this.defaultPageSize;var c=this.defaultPageSize;0===this.pageCount?this.pageSize=0:this.pageOffset+c>this.totalItems?this.pageSize=this.totalItems-this.pageOffset:this.pageSize=c},a.prototype.setRecordCount=function(a){this.itemsPerPage=this.pageSize,this.totalItems=a;var b=this.defaultPageSize;this.pageCount=(this.totalItems+b-1)/b|0},a}(),j=function(){function a(a){this.scope=a,this.initializeScope()}return a.prototype.initializeScope=function(){this.scope.tableColumns=0,this.scope.actions=[],this.scope.currentPage=0,this.scope.showPagination=!1,this.scope.paginationItems=7,this.scope.rows=[],this.scope.pageLoaded=!1,this.scope.toolbarButtons=[],this.scope.hasNewRecords=!1,this.scope.updating=!1,this.scope.recordSearchVisible=!1,this.scope.recordSearchText="",this.scope.columns=[],this.scope.hasRecordSearch=!1,this.scope.columnsSortable=!1},a.prototype.onDataDefinitionLoaded=function(a){this.scope.hasRecordSearch=a.hasSearch,this.initializeColumns(a),this.initializeActions(a),this.initializeColumnScopes(),this.scope.hasOptionsBar=this.scope.columns.length>0&&this.scope.actions.length>0},a.prototype.initializeColumnScopes=function(){this.scope.columns.forEach(function(a){a.colSpan=1,a.scope&&a.scope.length?a.context=new Function("obj","with(obj) { return "+a.scope+"; }"):a.context=function(a){return a}})},a.prototype.initializeActions=function(a){var b=this;this.scope.actions=[],a.actions&&Object.keys(a.actions).forEach(function(e){var f,g=a.actions[e];switch(f=g.visible&&g.visible.length>0?new Function("obj","with(obj) { return "+g.visible+"; }"):function(){return!0},g.type){case d.RECORD:case d.RECORD_CREATE:case d.RECORD_INITIALIZE_CREATE:var h=new c;h.name=e,h.title=g.title,h.visible=f,h.type=g.type,h.parameter=g.parameter,b.scope.actions.push(h);break;case d.CREATE:var h=new c;h.name=e,h.title=g.title,h.visible=f,h.type=g.parameter,b.scope.toolbarButtons.push(h)}})},a.prototype.initializeColumns=function(a){var b=this;this.scope.columns=[],this.scope.tableColumns=0,a.columns&&Object.keys(a.columns).forEach(function(c){var d=a.columns[c];switch(d.property=c,d.colSpan=d.colSpan||1,b.scope.columns.push(d),b.scope.tableColumns+=d.colSpan,d.headerClass||(d.headerClass=""),d.cellClass?d.cellClass+=" grid-data":d.cellClass="grid-data",d.sortable&&(b.scope.columnsSortable=!0),d.align){case"Left":d.cellClass+=" grid-left",d.headerClass+=" grid-left";break;case"Center":d.cellClass+=" grid-center",d.headerClass+=" grid-center";break;case"Right":d.cellClass+=" grid-right",d.headerClass+=" grid-right"}if(!d.template||0===d.template.length){var e="data."+d.property,f="ng-bind";d.allowUnsafe&&(e="getSafeValue("+e+")",f="ng-bind-html"),d.url&&d.url.length>0?d.template='<a href="{{getColumnLink(column, row)}}" ng-click="navigateToView(getColumnLink(column, row))" '+f+'="'+e+'"></a>':d.template="<span "+f+'="'+e+'"></span>'}})},a}(),k=function(){function a(a,b,c){var d=this;this.element=b,this.scope=a,this.compileService=c,this.scope.data=this.scope.column.context(this.scope.row.record),a.$watch(function(){return d.scope.column.template},function(a,b){d.updateValue()})}return a.prototype.updateValue=function(){this.element.contents().remove();var a=this.compileService(this.scope.column.template)(this.scope);this.element.append(a)},a}();a.directive("bindCell",["$compile",function(a){return{restrict:"EA",scope:{column:"=bindCell",row:"="},link:function(b,c){new k(b,c,a)}}}]);var l=function(){function a(a){}return a}();a.directive("recordListOptions",[function(){return{restrict:"EA",template:b["views/optionsBar.jade"],link:function(a){return new l(a)}}}]);var m=(function(){function a(){}return a}(),function(){function a(a){var b=this;this.scope=a,this.steps=2,this.fastSteps=5,a.$watchGroup(["pageSize","recordCount","currentPage"],function(){b.updateState()}),a.onFastBackward=function(){var a=b.scope.currentPage-b.fastSteps;0>=a&&(a=1),b.scope.currentPage=a},a.onBackward=function(){b.scope.currentPage>0&&b.scope.currentPage--},a.onForward=function(){b.scope.currentPage<b.pageCount&&b.scope.currentPage++},a.onFastForward=function(){var a=b.scope.currentPage+b.fastSteps;a>b.pageCount&&(a=b.pageCount),b.scope.currentPage=a},a.onPage=function(a){b.scope.currentPage=a.pageNumber},this.updateState()}return a.prototype.updateState=function(){if(this.scope.showPagination=this.scope.recordCount>this.scope.pageSize,this.scope.showPagination){this.pageCount=Math.floor((this.scope.recordCount+this.scope.pageSize-1)/this.scope.pageSize),this.scope.currentPage<1?this.scope.currentPage=1:this.scope.currentPage>this.pageCount&&(this.scope.currentPage=this.pageCount),this.scope.pages=[{title:this.scope.currentPage.toString(),pageNumber:this.scope.currentPage}];var a,b=this.scope.currentPage-1;for(a=0;a<this.steps&&b>0;b--,a++)this.scope.pages.unshift({title:b.toString(),pageNumber:b});var c=this.scope.currentPage+1;for(a=0;a<this.steps&&c<=this.pageCount;a++,c++)this.scope.pages.push({title:c.toString(),pageNumber:c});this.scope.showBackward=this.scope.currentPage>1,this.scope.showFastBackward=b-1>0,this.scope.showForward=this.scope.currentPage<this.pageCount,this.scope.showFastForward=c+1<=this.pageCount}},a}());a.directive("recordListPagination",[function(){return{restrict:"EA",scope:{pageSize:"=",recordCount:"=",currentPage:"="},template:b["views/paging.jade"],link:function(a){return new m(a)}}}]);var n=function(){function a(a,b,c,d){var e=this;this.scope=a,this.httpService=c,this.configuration=b,this.qService=d,this.modelId=a.model,this.dataDefinition=null,this.pageConfiguration=new i(b),this.dataChannelController=new h(a,this.pageConfiguration,this.configuration);var f=new j(a);this.setScopeEvents(),this.dataChannelController.subscribeToChannel(),this.scope.hasOptionsBar&&(this.scope.columns[0].colSpan=2),this.loadModel(f),this.scope.$watch("currentPage",function(){e.dataChannelController.showPage(e.scope.currentPage)})}return a.prototype.setScopeEvents=function(){var b=this;this.scope.onSearchRecords=function(){return b.onSearchRecords()},this.scope.onToggleRecordSearch=function(){return b.toggleRecordSearch()},this.scope.onRefreshNewRecords=function(){return b.dataChannelController.refreshNewRecords()},this.scope.onToolbarButtonClick=function(a){return b.onToolbarButtonClick(a)},this.scope.onClickOptions=function(a,c){return b.onClickOptions(a,c)},this.scope.isActionVisible=function(a,c){return b.isActionVisible(a,c)},this.scope.onSortColumn=function(a){return b.sortColumn(a)},this.scope.getColumnLink=function(b,c){return a.extractLink(b.url,c)},this.scope.onExecuteAction=function(a,c){return b.executeAction(a,c)},this.scope.onNavigateToLink=function(a){return b.configuration.navigate(a)},this.scope.getPageSize=function(){return b.configuration.pageSize},this.scope.getRecordCount=function(){return b.dataChannelController.getRecordCount()}},a.prototype.isActionVisible=function(a,b){return this.scope.hasOptionsBar?!a.visibleFunction||a.visibleFunction(b.record):!1},a.prototype.loadModel=function(a){var b=this;this.httpService.get(this.modelId+".json",{cache:!0}).then(function(c){b.onModelLoaded(c.data,a)},function(a){b.configuration.errorHandler&&b.configuration.errorHandler(a)})},a.prototype.onModelLoaded=function(a,b){var c=this;this.dataDefinition=a,this.dataDefinition.extensionScript&&this.dataDefinition.extensionScript.length?require([this.dataDefinition.extensionScript],function(d){d(c.scope),c.onModelAndExtensionsLoaded(a,b)}):this.onModelAndExtensionsLoaded(a,b)},a.prototype.onModelAndExtensionsLoaded=function(a,b){b.onDataDefinitionLoaded(a),this.dataChannelController.onModelLoaded(a),this.dataChannelController.refreshNewRecords()},a.prototype.onToolbarButtonClick=function(a){var b=this;!this.scope.updating&&this.scope.actionHandler&&this.scope.actionHandler(a.name,null).then(function(c){b.configuration.editRecord(c,function(c){var d=b.qService.defer();return b.scope.actionHandler(a.name,c).then(function(){d.resolve()},function(a){return d.reject(a)}),d.promise})})},a.prototype.onSearchRecords=function(){this.scope.recordSearchText.length>0?this.filter={search:this.scope.recordSearchText}:this.filter=null,this.dataChannelController.refreshNewRecords()},a.prototype.toggleRecordSearch=function(){this.scope.recordSearchVisible=!this.scope.recordSearchVisible,this.scope.recordSearchVisible||this.scope.recordSearchText.length>0&&(this.scope.recordSearchText="",this.onSearchRecords())},a.prototype.hideOptions=function(){for(var a=0;a<this.scope.rows.length;a++)this.scope.rows[a].showOptions=!1},a.prototype.onClickOptions=function(a,b){this.scope.updating||this.scope.hasOptionsBar&&(b&&b.target&&"A"===b.target.nodeName||(a.showOptions?a.showOptions=!1:(this.hideOptions(),a.showOptions=!0)))},a.prototype.sortColumn=function(a){if(a.sortable&&!this.scope.updating){for(var b=a.sort,c=0;c<this.scope.columns.length;c++){var a=this.scope.columns[c];a.sort=""}b=b&&b!==e.SORT_DIRECTION_UP?e.SORT_DIRECTION_UP:e.SORT_DIRECTION_DOWN,a.sort=b,this.hideOptions();var d=a.property;this.dataChannelController.sort(d,b),this.dataChannelController.showPage(1)}},a.prototype.editRecord=function(a){var b=this;this.configuration.editRecord(a,function(a){var c=b.qService.defer();return b.dataChannelController.writeRecords([a]).then(function(){c.resolve()},function(a){c.reject(a)}),c.promise})},a.prototype.executeAction=function(a,b){var c=this;if(a.name===e.MODIFY_RECORD_ACTION)return void this.editRecord(b.record);var f={};Object.keys(b.record).forEach(function(a){b.record.hasOwnProperty(a)&&(f[a]=b.record[a])});var g=function(){var b=c.qService.defer();return c.scope.actionHandler?c.scope.actionHandler(a.name,f).then(function(){b.resolve()}):b.resolve(),b.promise};a.type===d.RECORD_INITIALIZE_CREATE?this.scope.actionHandler&&this.scope.actionHandler(a.name,f).then(function(a){c.configuration.editRecord(a,function(a){return f=a,g()})},function(a){c.configuration.errorHandler&&c.configuration.errorHandler(a)}):a.type===d.RECORD_CREATE?this.configuration.editRecord(null,function(){return g()}):g()["catch"](function(a){c.configuration.errorHandler&&c.configuration.errorHandler(a)})},a.extractLink=function(a,b){for(var c=a,d=0;;){var e=c.indexOf("{",d);if(0>e)break;var f=c.indexOf("}",e);if(0>f)break;var g=c.substring(e+1,f);b.hasOwnProperty(g)?(g=b[g],c=c.substring(0,e)+g+c.substring(f+1),d+=g.length):d=e+1}return c},a}();a.directive("recordList",["recordListConfiguration","$http","$q",function(a,c,d){return{restrict:"EA",template:b["views/recordList.jade"],scope:{model:"@",channel:"=",actionHandler:"=",pageHandler:"="},link:function(b){return new n(b,a,c,d)}}}]);var o=function(){function a(a){}return a}();a.directive("recordListRefreshPanel",[function(){return{restrict:"EA",template:b["views/refreshPanel.jade"],link:function(a){return new o(a)}}}]);var p=function(){function a(a){}return a}();a.directive("recordListToolbar",[function(){return{restrict:"EA",template:b["views/toolBar.jade"],link:function(a){return new p(a)}}}])}if("function"==typeof define&&define.amd)define(["angular","angular.animate","angular.translate","angular.messages","angular.material","angular.aria","angular.touch"],function(b,c,d,e,f,g,h){a(b)});else if("object"==typeof exports){var b=require("angular");require("angular.animate"),require("angular.translate"),require("angular.messages"),require("angular.material"),require("angular.aria"),require("angular.touch"),module.exports=a(b)}else a(window.angular)}();